name: Backend Chat CI/CD

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Environment name
    environment: Production
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY_FOR_VPS }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          cd /var/www/chat_online/be_chat
          
          echo "ğŸ“¥ Pulling latest code..."
          git checkout main
          git fetch origin
          git pull origin main

           # --- Báº®T Äáº¦U PHáº¦N Táº O FILE .env ---
          echo "ğŸ“ Creating .env file..."

          # XÃ³a file .env cÅ© náº¿u tá»“n táº¡i Ä‘á»ƒ trÃ¡nh lá»—i
          rm -f .env 
          
          # Ghi tá»«ng biáº¿n mÃ´i trÆ°á»ng vÃ o file .env
          # Sá»­ dá»¥ng echo vÃ  redirect vÃ o file .env
          # LÆ°u Ã½: CÃ¡c secrets sáº½ Ä‘Æ°á»£c truyá»n tá»« GitHub Secrets vÃ o script nÃ y
          echo "NODE_ENV=${{ vars.NODE_ENV }}" >> .env
          echo "PORT=${{ vars.PORT }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}" >> .env
          echo "JWT_REFRESH_EXPIRES_IN=${{ secrets.JWT_REFRESH_EXPIRES_IN }}" >> .env
          
          echo "âœ… .env file created successfully."


          
          # Backup database trÆ°á»›c khi deploy (náº¿u container Ä‘ang cháº¡y)
          echo "ğŸ’¾ Creating database backup..."
          if docker ps -q -f name=chat-backend-container | grep -q .; then
            docker exec chat-backend-container cp /app/data/database.sqlite /app/data/backup_before_deploy.sqlite || echo "Backup failed, continuing..."
          fi
          
          # Stop vÃ  remove container cÅ© (giá»¯ nguyÃªn volume)
          echo "ğŸ›‘ Stopping old container..."
          docker stop chat-backend-container || true
          docker rm chat-backend-container || true
          
          # XÃ³a image cÅ© Ä‘á»ƒ tiáº¿t kiá»‡m dung lÆ°á»£ng
          echo "ğŸ—‘ï¸ Removing old image..."
          docker rmi chat-backend:latest || true
          
          # Build image má»›i
          echo "ğŸ”¨ Building new image..."
          docker build -t chat-backend:latest .
          
          # Táº¡o volume náº¿u chÆ°a tá»“n táº¡i
          echo "ğŸ“¦ Ensuring volume exists..."
          docker volume create backend_data || echo "Volume already exists"
          
          # Start container má»›i vá»›i volume mount
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name chat-backend-container \
            -p 8080:8080 \
            -v backend_data:/app/data \
            --restart unless-stopped \
            chat-backend:latest
